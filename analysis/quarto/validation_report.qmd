---
title: "ABM Validation Report"
author: "ABM Enterprise Coping Model"
date: today
params:
  output_dir: "../../outputs/toy"
  data_dir: "../../data/processed"
  country: "toy"
format:
  html:
    code-fold: true
    toc: true
    toc-depth: 3
    theme: cosmo
    embed-resources: true
execute:
  warning: false
  message: false
---

## Overview

This report validates the simulation outputs from the ABM Enterprise Coping Model
against expected patterns defined in the [Validation Contract](../../docs/VALIDATION_CONTRACT.md).

**Country/Mode:** `r params$country`

**Output Directory:** `r params$output_dir`

```{r setup}
#| message: false
#| warning: false

library(arrow)
library(dplyr)
library(tidyr)
library(ggplot2)
library(fixest)
library(gt)
library(jsonlite)
library(scales)

# Source helper functions
source("../R/read_simulation.R")
source("../R/validation_helpers.R")

# Set ggplot theme
theme_set(theme_minimal(base_size = 12))

# Status formatting helpers
format_status <- function(pass) {
  if (is.na(pass)) return("N/A")
  if (pass) "PASS" else "FAIL"
}

status_color <- function(pass) {
  if (is.na(pass)) return("gray")
  if (pass) "darkgreen" else "red"
}
```

```{r load-data}
#| message: false

# Read simulation outputs
sim_data <- read_simulation(params$output_dir)

# Extract for convenience
outcomes <- sim_data$outcomes
manifest <- sim_data$manifest

# Try to load empirical targets if country data exists
targets <- tryCatch({
  if (params$country != "toy") {
    read_derived_targets(params$data_dir, params$country)
  } else {
    NULL
  }
}, error = function(e) {
  message("Note: No empirical targets loaded (", e$message, ")")
  NULL
})

validation_mode <- if (is.null(targets)) "toy" else "full"
```

## 1. Manifest & Metadata

The simulation manifest contains metadata about the model run.

```{r manifest}
#| label: tbl-manifest
#| tbl-cap: "Simulation Parameters"

# Convert manifest to displayable format
manifest_df <- data.frame(
  Parameter = names(manifest),
  Value = sapply(manifest, function(x) {
    if (is.list(x)) {
      jsonlite::toJSON(x, auto_unbox = TRUE)
    } else {
      as.character(x)
    }
  }),
  stringsAsFactors = FALSE
)

manifest_df |>
  gt::gt() |>
  gt::tab_header(
    title = "Simulation Parameters",
    subtitle = sprintf("Run ID: %s", manifest$run_id %||% "N/A")
  ) |>
  gt::cols_width(
    Parameter ~ px(200),
    Value ~ px(400)
  )
```

## 2. Schema Validation

Validating that the simulation output conforms to the expected schema from `VALIDATION_CONTRACT.md`.

```{r schema}
#| results: hold

# Validate schema (this will error if invalid)
schema_valid <- tryCatch({
  validate_schema(outcomes)
  TRUE
}, error = function(e) {
  message("Schema validation failed: ", e$message)
  FALSE
})

# Create schema summary
schema_df <- data.frame(
  Column = names(outcomes),
  Type = sapply(outcomes, function(x) class(x)[1]),
  `Non-NA Count` = sapply(outcomes, function(x) sum(!is.na(x))),
  `Sample Values` = sapply(outcomes, function(x) {
    vals <- head(unique(x[!is.na(x)]), 3)
    paste(vals, collapse = ", ")
  }),
  check.names = FALSE
)
```

```{r schema-table}
#| label: tbl-schema
#| tbl-cap: "Schema Validation Results"

schema_df |>
  gt::gt() |>
  gt::tab_header(
    title = "Output Schema",
    subtitle = sprintf("Status: %s", if (schema_valid) "VALID" else "INVALID")
  ) |>
  gt::tab_style(
    style = list(
      gt::cell_fill(color = if (schema_valid) "#d4edda" else "#f8d7da")
    ),
    locations = gt::cells_title()
  )
```

## 3. Primary Estimand

The primary estimand tests whether negative price shocks increase enterprise entry:

$$\text{enterprise}_{it} = \beta_1 \times \text{price\_exposure}_{it} + \alpha_i + \gamma_t + \epsilon_{it}$$

**Target:** $\beta_1 < 0$ (price busts increase enterprise entry)

```{r regression-primary}
#| label: tbl-regression-primary
#| tbl-cap: "Primary Fixed Effects Regression"

fe_results <- run_fe_regression(outcomes, return_results = TRUE)
fe_model <- fe_results$model

# Display summary
summary(fe_model)
```

```{r regression-interpretation}
#| results: hold

cat("\n--- Primary Estimand Results ---\n")
cat(sprintf("Coefficient (price_exposure): %.4f\n", fe_results$coefficient))
cat(sprintf("Standard Error: %.4f\n", fe_results$std_error))
cat(sprintf("t-statistic: %.4f\n", fe_results$t_statistic))
cat(sprintf("p-value: %.4f\n", fe_results$p_value))
cat("\nExpected sign: Negative (price busts increase enterprise entry)\n")
cat(sprintf("Actual sign: %s\n",
            ifelse(fe_results$coefficient < 0, "NEGATIVE (as expected)", "POSITIVE (unexpected)")))
cat(sprintf("\nVALIDATION STATUS: %s\n", format_status(fe_results$pass)))
```

## 4. Heterogeneity Analysis

### 4.1 Asset Interaction

Testing whether low-asset households respond more strongly to price shocks:

$$\text{enterprise}_{it} = \beta_1 \times \text{price\_exposure}_{it} + \beta_2 \times (\text{price\_exposure}_{it} \times \text{low\_assets}_i) + \alpha_i + \gamma_t + \epsilon_{it}$$

**Target:** $\beta_2 < 0$ (low-asset households more responsive)

```{r regression-assets}
#| label: tbl-regression-assets
#| tbl-cap: "Asset Interaction Regression"

asset_results <- run_asset_interaction_regression(outcomes, return_results = TRUE)
asset_model <- asset_results$model
summary(asset_model)
```

```{r asset-interpretation}
#| results: hold

cat("\n--- Asset Interaction Results ---\n")
cat(sprintf("Interaction Coefficient: %.4f\n", asset_results$coefficient))
cat(sprintf("Standard Error: %.4f\n", asset_results$std_error))
cat(sprintf("p-value: %.4f\n", asset_results$p_value))
cat(sprintf("\nVALIDATION STATUS: %s\n", format_status(asset_results$pass)))
```

### 4.2 Credit Access Interaction

Testing whether credit-constrained households respond more strongly:

$$\text{enterprise}_{it} = \beta_1 \times \text{price\_exposure}_{it} + \beta_2 \times (\text{price\_exposure}_{it} \times \text{no\_credit}_i) + \alpha_i + \gamma_t + \epsilon_{it}$$

**Target:** $\beta_2 < 0$ (credit-constrained households more responsive)

```{r regression-credit}
#| label: tbl-regression-credit
#| tbl-cap: "Credit Access Interaction Regression"

credit_results <- run_credit_interaction_regression(outcomes, return_results = TRUE)
credit_model <- credit_results$model
summary(credit_model)
```

```{r credit-interpretation}
#| results: hold

cat("\n--- Credit Interaction Results ---\n")
cat(sprintf("Interaction Coefficient: %.4f\n", credit_results$coefficient))
cat(sprintf("Standard Error: %.4f\n", credit_results$std_error))
cat(sprintf("p-value: %.4f\n", credit_results$p_value))
cat(sprintf("\nVALIDATION STATUS: %s\n", format_status(credit_results$pass)))
```

## 5. Distribution Comparisons

```{r distribution-setup}
# Calculate summary statistics
summaries <- calculate_summaries(outcomes)

# Run distribution comparison if targets available
if (!is.null(targets)) {
  dist_results <- compare_distributions(outcomes, targets, variable = "enterprise_status")
} else {
  dist_results <- compare_distributions(outcomes, NULL, variable = "enterprise_status")
}
```

### 5.1 Enterprise Rate by Wave

```{r plot-enterprise-wave}
#| label: fig-enterprise-wave
#| fig-cap: "Enterprise Rate by Wave"

sim_by_wave <- outcomes |>
  group_by(wave) |>
  summarize(
    enterprise_rate = mean(as.numeric(enterprise_status), na.rm = TRUE),
    source = "Simulated",
    .groups = "drop"
  )

if (!is.null(targets)) {
  obs_by_wave <- targets |>
    group_by(wave) |>
    summarize(
      enterprise_rate = mean(as.numeric(enterprise_indicator), na.rm = TRUE),
      source = "Observed",
      .groups = "drop"
    )
  wave_data <- bind_rows(sim_by_wave, obs_by_wave)
} else {
  wave_data <- sim_by_wave
}

ggplot(wave_data, aes(x = factor(wave), y = enterprise_rate, fill = source)) +
  geom_col(position = position_dodge(width = 0.8), alpha = 0.8, width = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", enterprise_rate * 100)),
            position = position_dodge(width = 0.8), vjust = -0.5, size = 3) +
  scale_y_continuous(labels = scales::percent_format(), expand = expansion(mult = c(0, 0.15))) +
  scale_fill_manual(values = c("Simulated" = "steelblue", "Observed" = "darkgreen")) +
  labs(
    title = "Enterprise Rate by Wave",
    subtitle = if (!is.null(targets)) "Simulated vs Observed" else "Simulated (No Observed Data)",
    x = "Wave",
    y = "Enterprise Rate",
    fill = "Source"
  ) +
  theme(legend.position = "bottom")
```

### 5.2 Price Exposure Distribution

```{r plot-price-exposure}
#| label: fig-price-exposure
#| fig-cap: "Distribution of Price Exposure"

if (!is.null(targets)) {
  price_data <- bind_rows(
    outcomes |> select(price_exposure) |> mutate(source = "Simulated"),
    targets |> select(price_exposure) |> mutate(source = "Observed")
  )

  ggplot(price_data, aes(x = price_exposure, fill = source)) +
    geom_density(alpha = 0.5) +
    scale_fill_manual(values = c("Simulated" = "steelblue", "Observed" = "darkgreen")) +
    labs(
      title = "Price Exposure Distribution",
      subtitle = "Simulated vs Observed",
      x = "Price Exposure",
      y = "Density",
      fill = "Source"
    ) +
    theme(legend.position = "bottom")
} else {
  ggplot(outcomes, aes(x = price_exposure)) +
    geom_histogram(bins = 30, fill = "steelblue", alpha = 0.8, color = "white") +
    geom_vline(xintercept = mean(outcomes$price_exposure, na.rm = TRUE),
               color = "red", linetype = "dashed", linewidth = 1) +
    labs(
      title = "Distribution of Price Exposure",
      subtitle = "Red dashed line = mean",
      x = "Price Exposure",
      y = "Count"
    )
}
```

### 5.3 Enterprise Rate by Asset Quintile

```{r plot-enterprise-assets}
#| label: fig-enterprise-assets
#| fig-cap: "Enterprise Rate by Asset Quintile"

# Simulated
sim_by_quintile <- outcomes |>
  mutate(asset_quintile = ntile(assets, 5)) |>
  group_by(asset_quintile) |>
  summarize(
    enterprise_rate = mean(as.numeric(enterprise_status), na.rm = TRUE),
    source = "Simulated",
    .groups = "drop"
  )

if (!is.null(targets) && "asset_quintile" %in% names(targets)) {
  obs_by_quintile <- targets |>
    group_by(asset_quintile) |>
    summarize(
      enterprise_rate = mean(as.numeric(enterprise_indicator), na.rm = TRUE),
      source = "Observed",
      .groups = "drop"
    )
  quintile_data <- bind_rows(sim_by_quintile, obs_by_quintile)
} else {
  quintile_data <- sim_by_quintile
}

ggplot(quintile_data, aes(x = factor(asset_quintile), y = enterprise_rate, fill = source)) +
  geom_col(position = position_dodge(width = 0.8), alpha = 0.8, width = 0.7) +
  scale_y_continuous(labels = scales::percent_format(), expand = expansion(mult = c(0, 0.15))) +
  scale_fill_manual(values = c("Simulated" = "steelblue", "Observed" = "darkgreen")) +
  labs(
    title = "Enterprise Rate by Asset Quintile",
    subtitle = "Q1 = Lowest Assets, Q5 = Highest Assets",
    x = "Asset Quintile",
    y = "Enterprise Rate",
    fill = "Source"
  ) +
  theme(legend.position = "bottom")
```

### 5.4 Distribution Test Results

```{r distribution-tests}
#| label: tbl-distribution-tests
#| tbl-cap: "Distribution Comparison Tests"

if (dist_results$mode == "validation") {
  dist_test_df <- data.frame(
    Test = c("KS Test", "Chi-squared Test"),
    Statistic = c(dist_results$ks_statistic, dist_results$chi2_statistic),
    `P-value` = c(dist_results$ks_pvalue, dist_results$chi2_pvalue),
    `Threshold` = c("> 0.05", "> 0.05"),
    Status = c(
      if (dist_results$ks_pvalue > 0.05) "PASS" else "FAIL",
      if (!is.na(dist_results$chi2_pvalue) && dist_results$chi2_pvalue > 0.05) "PASS" else "N/A"
    ),
    check.names = FALSE
  )

  dist_test_df |>
    gt::gt() |>
    gt::fmt_number(columns = c(Statistic, `P-value`), decimals = 4) |>
    gt::tab_header(
      title = "Distribution Comparison Tests",
      subtitle = "Enterprise Rate Distribution"
    )
} else {
  cat("Distribution tests require observed data. Running in toy mode.\n")
}
```

## 6. Classification Validation

Classifying households based on enterprise persistence:

- **Stayer**: Operates enterprise in >50% of observed waves
- **Coper**: Operates enterprise in >0% and <=50% of observed waves (intermittent)
- **None**: Never operates enterprise

::: {.callout-note}
## Methods Note: Classification Threshold

The 50% threshold operationalizes "majority-of-periods" enterprise participation. This is an
**operationalization choice** rather than a structural parameter. Key points:

1. **Rationale**: Stayers operate enterprises "more often than not" across observed waves
2. **Panel mapping**: For 4-wave Tanzania (2+ waves) and 3-wave Ethiopia (2+ waves)
3. **Sensitivity**: Core conclusions must be robust to thresholds {0.33, 0.50, 0.67}

See `docs/THRESHOLD_JUSTIFICATION.md` for full scientific justification.
:::

```{r classification}
#| label: tbl-classification
#| tbl-cap: "Stayer/Coper Classification"

# Get simulated classification
sim_class <- get_classification_summary(outcomes) |>
  mutate(source = "Simulated")

# Get observed classification if available
if (!is.null(targets)) {
  obs_class <- get_classification_summary(targets) |>
    mutate(source = "Observed")
  class_data <- bind_rows(sim_class, obs_class)

  # Run comparison
  class_comparison <- compare_classification(outcomes, targets)
} else {
  class_data <- sim_class
  class_comparison <- NULL
}

class_data |>
  pivot_wider(names_from = source, values_from = c(n, proportion)) |>
  gt::gt() |>
  gt::fmt_percent(columns = starts_with("proportion"), decimals = 1) |>
  gt::tab_header(
    title = "Household Classification",
    subtitle = "Based on enterprise persistence across waves"
  )
```

```{r plot-classification}
#| label: fig-classification
#| fig-cap: "Distribution of Household Classifications"

ggplot(class_data, aes(x = classification, y = proportion, fill = source)) +
  geom_col(position = position_dodge(width = 0.8), alpha = 0.8, width = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", proportion * 100)),
            position = position_dodge(width = 0.8), vjust = -0.3, size = 3) +
  scale_y_continuous(labels = scales::percent_format(), expand = expansion(mult = c(0, 0.15))) +
  scale_fill_manual(values = c("Simulated" = "steelblue", "Observed" = "darkgreen")) +
  labs(
    title = "Household Classification Distribution",
    x = "Classification",
    y = "Proportion",
    fill = "Source"
  ) +
  theme(legend.position = "bottom")
```

```{r classification-comparison}
#| results: hold

if (!is.null(class_comparison)) {
  cat("\n--- Classification Comparison ---\n")
  cat(sprintf("Stayer: sim=%.1f%%, obs=%.1f%%, diff=%.1fpp - %s\n",
              class_comparison$stayer_sim * 100,
              class_comparison$stayer_obs * 100,
              class_comparison$stayer_diff * 100,
              format_status(class_comparison$stayer_within_10pp)))
  cat(sprintf("Coper:  sim=%.1f%%, obs=%.1f%%, diff=%.1fpp - %s\n",
              class_comparison$coper_sim * 100,
              class_comparison$coper_obs * 100,
              class_comparison$coper_diff * 100,
              format_status(class_comparison$coper_within_10pp)))
} else {
  cat("Classification comparison requires observed data.\n")
}
```

## 7. Summary Table

```{r summary-table}
#| label: tbl-summary
#| tbl-cap: "Validation Summary"

# Build summary rows
summary_rows <- list()

# Primary estimand
summary_rows[[1]] <- data.frame(
  Test = "Primary Estimand (beta_1 < 0)",
  Value = sprintf("beta = %.4f, p = %.4f", fe_results$coefficient, fe_results$p_value),
  Criterion = "beta < 0, p < 0.05",
  Status = format_status(fe_results$pass)
)

# Asset interaction
summary_rows[[2]] <- data.frame(
  Test = "Asset Interaction (beta_2 < 0)",
  Value = sprintf("beta = %.4f, p = %.4f", asset_results$coefficient, asset_results$p_value),
  Criterion = "beta < 0, p < 0.05",
  Status = format_status(asset_results$pass)
)

# Credit interaction
summary_rows[[3]] <- data.frame(
  Test = "Credit Interaction (beta_2 < 0)",
  Value = sprintf("beta = %.4f, p = %.4f", credit_results$coefficient, credit_results$p_value),
  Criterion = "beta < 0, p < 0.05",
  Status = format_status(credit_results$pass)
)

# Distribution tests (if available)
if (dist_results$mode == "validation") {
  summary_rows[[4]] <- data.frame(
    Test = "Enterprise Rate Distribution",
    Value = sprintf("KS p = %.4f", dist_results$ks_pvalue),
    Criterion = "KS p > 0.05",
    Status = format_status(dist_results$pass)
  )
}

# Classification (if available)
if (!is.null(class_comparison)) {
  summary_rows[[5]] <- data.frame(
    Test = "Stayer Proportion",
    Value = sprintf("sim: %.1f%%, obs: %.1f%%, diff: %.1fpp",
                    class_comparison$stayer_sim * 100,
                    class_comparison$stayer_obs * 100,
                    class_comparison$stayer_diff * 100),
    Criterion = "< 10pp difference",
    Status = format_status(class_comparison$stayer_within_10pp)
  )
  summary_rows[[6]] <- data.frame(
    Test = "Coper Proportion",
    Value = sprintf("sim: %.1f%%, obs: %.1f%%, diff: %.1fpp",
                    class_comparison$coper_sim * 100,
                    class_comparison$coper_obs * 100,
                    class_comparison$coper_diff * 100),
    Criterion = "< 10pp difference",
    Status = format_status(class_comparison$coper_within_10pp)
  )
}

summary_df <- do.call(rbind, summary_rows)

summary_df |>
  gt::gt() |>
  gt::tab_header(
    title = "Validation Summary",
    subtitle = sprintf("Mode: %s | Country: %s", validation_mode, params$country)
  ) |>
  gt::tab_style(
    style = list(gt::cell_fill(color = "#d4edda")),
    locations = gt::cells_body(columns = Status, rows = Status == "PASS")
  ) |>
  gt::tab_style(
    style = list(gt::cell_fill(color = "#f8d7da")),
    locations = gt::cells_body(columns = Status, rows = Status == "FAIL")
  ) |>
  gt::tab_style(
    style = list(gt::cell_fill(color = "#e2e3e5")),
    locations = gt::cells_body(columns = Status, rows = Status == "N/A")
  )
```

## Conclusions

```{r conclusions}
#| results: hold

cat("=== VALIDATION SUMMARY ===\n\n")

# Overall statistics
n_obs <- nrow(outcomes)
n_households <- length(unique(outcomes$household_id))
n_waves <- length(unique(outcomes$wave))

cat(sprintf("Data Summary:\n"))
cat(sprintf("  - Observations: %d\n", n_obs))
cat(sprintf("  - Unique households: %d\n", n_households))
cat(sprintf("  - Waves: %d\n", n_waves))
cat(sprintf("  - Panel balanced: %s\n\n", ifelse(n_obs == n_households * n_waves, "YES", "NO")))

cat("Validation Results:\n")
cat(sprintf("  - Primary Estimand (beta_1 < 0): %s\n", format_status(fe_results$pass)))
cat(sprintf("  - Asset Interaction (beta_2 < 0): %s\n", format_status(asset_results$pass)))
cat(sprintf("  - Credit Interaction: %s\n", format_status(credit_results$pass)))

if (dist_results$mode == "validation") {
  cat(sprintf("  - Distribution Match: %s\n", format_status(dist_results$pass)))
}

if (!is.null(class_comparison)) {
  cat(sprintf("  - Stayer Proportion: %s\n", format_status(class_comparison$stayer_within_10pp)))
  cat(sprintf("  - Coper Proportion: %s\n", format_status(class_comparison$coper_within_10pp)))
}

# Overall pass/fail
all_pass <- fe_results$pass && asset_results$pass && credit_results$pass
if (dist_results$mode == "validation") {
  all_pass <- all_pass && dist_results$pass
}
if (!is.null(class_comparison)) {
  all_pass <- all_pass && class_comparison$pass
}

cat(sprintf("\n=== OVERALL STATUS: %s ===\n", if (all_pass) "PASS" else "FAIL"))
```

---

*Report generated on `r Sys.time()`*
