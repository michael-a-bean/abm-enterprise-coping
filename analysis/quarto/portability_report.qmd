---
title: "ABM Portability Report: Cross-Country Validation"
subtitle: "LLM Generalization and Model Portability Testing"
author: "ABM Enterprise Coping Model"
date: today
params:
  data_dir: "../../data/processed"
  eval_dir: "../../outputs/eval_crosscountry"
  tz_output_dir: "../../outputs/tanzania/baseline"
  eth_output_dir: "../../outputs/ethiopia/baseline"
format:
  html:
    code-fold: true
    toc: true
    toc-depth: 3
    theme: cosmo
    embed-resources: true
execute:
  warning: false
  message: false
---

## Overview

This report tests the **portability** and **generalization** capabilities of the ABM Enterprise Coping Model across countries. The key question:

> **Can LLM decisions and ML baselines trained on Tanzania generalize to Ethiopia?**

According to the [Validation Contract](../../docs/VALIDATION_CONTRACT.md), portability validation requires:
- Sign preservation on all main effects across countries
- LLM generalization: predictions should not degrade significantly on unseen country

```{r setup}
#| message: false
#| warning: false

library(arrow)
library(dplyr)
library(tidyr)
library(ggplot2)
library(fixest)
library(gt)
library(scales)
library(patchwork)
library(jsonlite)

# Source helper functions
source("../R/read_simulation.R")
source("../R/validation_helpers.R")

# Set ggplot theme
theme_set(theme_minimal(base_size = 12))

# Status formatting
format_status <- function(pass) {
  if (is.na(pass)) return("N/A")
  if (pass) "PASS" else "FAIL"
}
```

```{r load-data}
#| message: false

# Load Tanzania empirical targets
tz_targets <- tryCatch({
  read_derived_targets(params$data_dir, "tanzania")
}, error = function(e) {
  message("Tanzania targets not found: ", e$message)
  NULL
})

# Load Ethiopia empirical targets
eth_targets <- tryCatch({
  read_derived_targets(params$data_dir, "ethiopia")
}, error = function(e) {
  message("Ethiopia targets not found: ", e$message)
  NULL
})

# Load cross-country evaluation results
cross_country_predictions <- tryCatch({
  arrow::read_parquet(file.path(params$eval_dir, "predictions.parquet"))
}, error = function(e) {
  message("Cross-country predictions not found: ", e$message)
  NULL
})

cross_country_metrics <- tryCatch({
  jsonlite::fromJSON(file.path(params$eval_dir, "metrics.json"))
}, error = function(e) {
  message("Cross-country metrics not found: ", e$message)
  NULL
})

cross_country_comparison <- tryCatch({
  read.csv(file.path(params$eval_dir, "model_comparison.csv"))
}, error = function(e) {
  message("Cross-country comparison not found: ", e$message)
  NULL
})

# Load same-country (Tanzania) evaluation for comparison
tz_eval_comparison <- tryCatch({
  read.csv(file.path(dirname(params$eval_dir), "eval_tanzania", "model_comparison.csv"))
}, error = function(e) {
  NULL
})

# Check data availability
has_tz_targets <- !is.null(tz_targets)
has_eth_targets <- !is.null(eth_targets)
has_cross_country_eval <- !is.null(cross_country_comparison)
has_tz_eval <- !is.null(tz_eval_comparison)
```

## 1. Data Availability

```{r data-availability}
#| label: tbl-data-availability
#| tbl-cap: "Data Availability Summary"

availability_df <- data.frame(
  Data = c("Tanzania Targets", "Ethiopia Targets",
           "Cross-Country Evaluation", "Tanzania Evaluation (Reference)"),
  Status = c(
    if (has_tz_targets) "Available" else "Missing",
    if (has_eth_targets) "Available" else "Missing",
    if (has_cross_country_eval) "Available" else "Missing",
    if (has_tz_eval) "Available" else "Missing"
  ),
  Description = c(
    "LSMS-ISA derived targets (4 waves)",
    "LSMS-ISA derived targets (3 waves)",
    "LLM predictions on Ethiopia with baselines trained on Tanzania",
    "LLM predictions on Tanzania for comparison"
  )
)

availability_df |>
  gt::gt() |>
  gt::tab_header(
    title = "Data Availability",
    subtitle = "Required inputs for portability validation"
  )
```

# Part 1: Cross-Country LLM Generalization {.tabset}

This section tests whether LLM decisions generalize across countries. The key advantage of LLMs is that they may generalize better than ML baselines trained on country-specific data.

## 1.1 Generalization Comparison

```{r generalization-comparison}
#| label: tbl-generalization
#| tbl-cap: "LLM vs ML Baseline Generalization"

if (has_cross_country_eval && has_tz_eval) {
  # Prepare comparison data
  llm_tz <- tz_eval_comparison |>
    dplyr::filter(grepl("llm", model, ignore.case = TRUE)) |>
    dplyr::slice(1) |>
    dplyr::mutate(context = "Same-Country (TZ→TZ)")

  llm_cross <- cross_country_comparison |>
    dplyr::filter(grepl("llm", model, ignore.case = TRUE)) |>
    dplyr::slice(1) |>
    dplyr::mutate(context = "Cross-Country (TZ→ETH)")

  best_ml_tz <- tz_eval_comparison |>
    dplyr::filter(!grepl("llm", model, ignore.case = TRUE)) |>
    dplyr::arrange(desc(macro_f1)) |>
    dplyr::slice(1) |>
    dplyr::mutate(context = "Same-Country (TZ→TZ)")

  best_ml_cross <- cross_country_comparison |>
    dplyr::filter(!grepl("llm", model, ignore.case = TRUE)) |>
    dplyr::arrange(desc(macro_f1)) |>
    dplyr::slice(1) |>
    dplyr::mutate(context = "Cross-Country (TZ→ETH)")

  # Combine for comparison
  gen_comparison <- bind_rows(
    llm_tz |> dplyr::mutate(model_type = "LLM"),
    llm_cross |> dplyr::mutate(model_type = "LLM"),
    best_ml_tz |> dplyr::mutate(model_type = paste0("Best ML (", model, ")")),
    best_ml_cross |> dplyr::mutate(model_type = paste0("Best ML (", model, ")"))
  )

  gen_comparison |>
    dplyr::select(
      `Model Type` = model_type,
      Context = context,
      Accuracy = accuracy,
      `Balanced Acc.` = balanced_accuracy,
      `Macro F1` = macro_f1,
      `F1 ENTER` = f1_ENTER,
      `F1 EXIT` = f1_EXIT,
      `F1 STAY` = f1_STAY
    ) |>
    dplyr::mutate(
      across(c(Accuracy, `Balanced Acc.`, `Macro F1`, `F1 ENTER`, `F1 EXIT`, `F1 STAY`),
             ~round(., 3))
    ) |>
    gt::gt() |>
    gt::tab_header(
      title = "Cross-Country Generalization Comparison",
      subtitle = "LLM vs ML Baselines: Same-Country vs Cross-Country"
    ) |>
    gt::tab_row_group(
      label = "Cross-Country (Train: Tanzania → Test: Ethiopia)",
      rows = Context == "Cross-Country (TZ→ETH)"
    ) |>
    gt::tab_row_group(
      label = "Same-Country (Train & Test: Tanzania)",
      rows = Context == "Same-Country (TZ→TZ)"
    ) |>
    gt::tab_footnote(
      footnote = "LLM requires no training data. ML baselines were trained on Tanzania.",
      locations = gt::cells_column_labels(columns = `Model Type`)
    )
} else if (has_cross_country_eval) {
  cross_country_comparison |>
    dplyr::arrange(desc(macro_f1)) |>
    dplyr::mutate(
      rank = row_number(),
      across(c(accuracy, balanced_accuracy, macro_f1, weighted_f1,
               f1_ENTER, f1_EXIT, f1_STAY), ~round(., 3))
    ) |>
    dplyr::select(Rank = rank, Model = model, Accuracy = accuracy,
                  `Macro F1` = macro_f1,
                  `F1 ENTER` = f1_ENTER, `F1 EXIT` = f1_EXIT, `F1 STAY` = f1_STAY) |>
    gt::gt() |>
    gt::tab_header(
      title = "Cross-Country Model Performance",
      subtitle = "Trained on Tanzania, Tested on Ethiopia"
    )
} else {
  cat("Cross-country evaluation results not available. Run eval-direct with cross-country configuration first.\n")
}
```

## 1.2 Generalization Gap Analysis

```{r generalization-gap}
#| label: fig-generalization-gap
#| fig-cap: "Generalization Gap: Performance Drop from Same-Country to Cross-Country"

if (has_cross_country_eval && has_tz_eval) {
  # Calculate performance drop for each model
  gap_data <- bind_rows(
    # LLM
    data.frame(
      model = "LLM",
      same_country = llm_tz$macro_f1,
      cross_country = llm_cross$macro_f1,
      gap = llm_tz$macro_f1 - llm_cross$macro_f1
    ),
    # Best ML
    data.frame(
      model = best_ml_tz$model,
      same_country = best_ml_tz$macro_f1,
      cross_country = best_ml_cross$macro_f1,
      gap = best_ml_tz$macro_f1 - best_ml_cross$macro_f1
    )
  )

  # Add all ML baselines from cross-country
  ml_baselines <- cross_country_comparison |>
    dplyr::filter(!grepl("llm", model, ignore.case = TRUE))

  if (nrow(ml_baselines) > 0) {
    for (i in seq_len(nrow(ml_baselines))) {
      ml_name <- ml_baselines$model[i]
      tz_match <- tz_eval_comparison |> dplyr::filter(model == ml_name)
      if (nrow(tz_match) > 0) {
        gap_data <- bind_rows(gap_data, data.frame(
          model = ml_name,
          same_country = tz_match$macro_f1,
          cross_country = ml_baselines$macro_f1[i],
          gap = tz_match$macro_f1 - ml_baselines$macro_f1[i]
        ))
      }
    }
    gap_data <- gap_data |> distinct(model, .keep_all = TRUE)
  }

  # Plot
  ggplot(gap_data, aes(x = reorder(model, -gap), y = gap, fill = model == "LLM")) +
    geom_col(alpha = 0.8) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
    scale_fill_manual(values = c("TRUE" = "steelblue", "FALSE" = "gray60"),
                      labels = c("TRUE" = "LLM", "FALSE" = "ML Baseline")) +
    labs(
      title = "Generalization Gap by Model",
      subtitle = "Smaller gap = Better cross-country generalization",
      x = "Model",
      y = "Performance Drop (Same-Country - Cross-Country F1)",
      fill = "Model Type"
    ) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "bottom"
    ) +
    coord_flip()
} else {
  cat("Generalization gap analysis requires both same-country and cross-country evaluation results.\n")
}
```

## 1.3 Per-Class Generalization

```{r per-class-generalization}
#| label: fig-per-class-gen
#| fig-cap: "Per-Class F1 Scores: Same-Country vs Cross-Country"

if (has_cross_country_eval && has_tz_eval) {
  # Prepare per-class comparison for LLM
  per_class_data <- data.frame(
    class = rep(c("ENTER", "EXIT", "STAY"), 2),
    context = c(rep("Same-Country", 3), rep("Cross-Country", 3)),
    f1_score = c(
      llm_tz$f1_ENTER, llm_tz$f1_EXIT, llm_tz$f1_STAY,
      llm_cross$f1_ENTER, llm_cross$f1_EXIT, llm_cross$f1_STAY
    )
  )

  ggplot(per_class_data, aes(x = class, y = f1_score, fill = context)) +
    geom_col(position = position_dodge(width = 0.8), alpha = 0.8, width = 0.7) +
    geom_text(aes(label = sprintf("%.2f", f1_score)),
              position = position_dodge(width = 0.8), vjust = -0.3, size = 3) +
    scale_y_continuous(limits = c(0, 1), expand = expansion(mult = c(0, 0.1))) +
    scale_fill_manual(values = c("Same-Country" = "steelblue", "Cross-Country" = "darkgreen")) +
    labs(
      title = "LLM Per-Class F1: Same-Country vs Cross-Country",
      subtitle = "Testing generalization on each transition type",
      x = "Transition Class",
      y = "F1 Score",
      fill = "Evaluation Context"
    ) +
    theme(legend.position = "bottom")
} else {
  cat("Per-class generalization analysis requires both evaluation results.\n")
}
```

# Part 2: Empirical Data Comparison {.tabset}

## 2.1 Sample Statistics

```{r sample-stats}
#| label: tbl-sample-stats
#| tbl-cap: "Sample Statistics by Country"

if (has_tz_targets && has_eth_targets) {
  tz_stats <- data.frame(
    Country = "Tanzania",
    `N Households` = length(unique(tz_targets$household_id)),
    `N Observations` = nrow(tz_targets),
    `N Waves` = length(unique(tz_targets$wave)),
    `Enterprise Rate` = mean(tz_targets$enterprise_indicator, na.rm = TRUE),
    `Mean Price Exposure` = mean(tz_targets$price_exposure, na.rm = TRUE),
    check.names = FALSE
  )

  eth_stats <- data.frame(
    Country = "Ethiopia",
    `N Households` = length(unique(eth_targets$household_id)),
    `N Observations` = nrow(eth_targets),
    `N Waves` = length(unique(eth_targets$wave)),
    `Enterprise Rate` = mean(eth_targets$enterprise_indicator, na.rm = TRUE),
    `Mean Price Exposure` = mean(eth_targets$price_exposure, na.rm = TRUE),
    check.names = FALSE
  )

  bind_rows(tz_stats, eth_stats) |>
    gt::gt() |>
    gt::fmt_number(columns = c(`Enterprise Rate`, `Mean Price Exposure`), decimals = 3) |>
    gt::tab_header(
      title = "Sample Statistics",
      subtitle = "LSMS-ISA empirical data comparison"
    )
} else {
  cat("Requires both Tanzania and Ethiopia empirical data.\n")
}
```

## 2.2 Enterprise Rate Distribution

```{r plot-enterprise-rates}
#| label: fig-enterprise-rates
#| fig-cap: "Enterprise Rates by Country and Wave"

if (has_tz_targets && has_eth_targets) {
  tz_by_wave <- tz_targets |>
    group_by(wave) |>
    summarize(
      enterprise_rate = mean(enterprise_indicator, na.rm = TRUE),
      n = n(),
      .groups = "drop"
    ) |>
    mutate(country = "Tanzania")

  eth_by_wave <- eth_targets |>
    group_by(wave) |>
    summarize(
      enterprise_rate = mean(enterprise_indicator, na.rm = TRUE),
      n = n(),
      .groups = "drop"
    ) |>
    mutate(country = "Ethiopia")

  wave_data <- bind_rows(tz_by_wave, eth_by_wave)

  ggplot(wave_data, aes(x = factor(wave), y = enterprise_rate, fill = country)) +
    geom_col(position = position_dodge(width = 0.8), alpha = 0.8, width = 0.7) +
    geom_text(aes(label = sprintf("%.1f%%", enterprise_rate * 100)),
              position = position_dodge(width = 0.8), vjust = -0.5, size = 3) +
    scale_y_continuous(labels = scales::percent_format(), expand = expansion(mult = c(0, 0.15))) +
    scale_fill_manual(values = c("Tanzania" = "steelblue", "Ethiopia" = "darkgreen")) +
    labs(
      title = "Enterprise Rate by Wave",
      x = "Wave",
      y = "Enterprise Rate",
      fill = "Country"
    ) +
    theme(legend.position = "bottom")
}
```

# Part 3: Regression-Based Portability {.tabset}

## 3.1 Primary Estimand

Running the primary fixed effects regression on empirical data from each country:

$$\text{enterprise}_{it} = \beta_1 \times \text{price\_exposure}_{it} + \alpha_i + \gamma_t + \epsilon_{it}$$

```{r regression-primary}
#| label: tbl-regression-primary
#| tbl-cap: "Primary Estimand Comparison"

if (has_tz_targets && has_eth_targets) {
  tz_primary <- run_fe_regression(tz_targets, return_results = TRUE)
  eth_primary <- run_fe_regression(eth_targets, return_results = TRUE)

  primary_df <- data.frame(
    Country = c("Tanzania", "Ethiopia"),
    Coefficient = c(tz_primary$coefficient, eth_primary$coefficient),
    `Std. Error` = c(tz_primary$std_error, eth_primary$std_error),
    `t-statistic` = c(tz_primary$t_statistic, eth_primary$t_statistic),
    `P-value` = c(tz_primary$p_value, eth_primary$p_value),
    `Sign Correct` = c(tz_primary$sign_match, eth_primary$sign_match),
    check.names = FALSE
  )

  primary_df |>
    gt::gt() |>
    gt::fmt_number(columns = c(Coefficient, `Std. Error`, `t-statistic`), decimals = 4) |>
    gt::fmt_scientific(columns = `P-value`, decimals = 2) |>
    gt::tab_header(
      title = "Primary Estimand: Price Exposure Effect",
      subtitle = "Target: beta_1 < 0 (negative price shocks increase enterprise)"
    )
} else {
  tz_primary <- eth_primary <- list(coefficient = NA, std_error = NA, sign_match = NA)
  cat("Requires both Tanzania and Ethiopia empirical data.\n")
}
```

## 3.2 Asset Interaction

```{r regression-assets}
#| label: tbl-regression-assets
#| tbl-cap: "Asset Interaction Comparison"

if (has_tz_targets && has_eth_targets) {
  tz_assets <- run_asset_interaction_regression(tz_targets, return_results = TRUE)
  eth_assets <- run_asset_interaction_regression(eth_targets, return_results = TRUE)

  assets_df <- data.frame(
    Country = c("Tanzania", "Ethiopia"),
    `Interaction Coefficient` = c(tz_assets$coefficient, eth_assets$coefficient),
    `Std. Error` = c(tz_assets$std_error, eth_assets$std_error),
    `P-value` = c(tz_assets$p_value, eth_assets$p_value),
    `Sign Correct` = c(tz_assets$sign_match, eth_assets$sign_match),
    check.names = FALSE
  )

  assets_df |>
    gt::gt() |>
    gt::fmt_number(columns = c(`Interaction Coefficient`, `Std. Error`), decimals = 4) |>
    gt::fmt_scientific(columns = `P-value`, decimals = 2) |>
    gt::tab_header(
      title = "Asset Interaction Effect",
      subtitle = "Target: beta_2 < 0 (low-asset households more responsive)"
    )
} else {
  tz_assets <- eth_assets <- list(coefficient = NA, std_error = NA, sign_match = NA)
}
```

## 3.3 Credit Interaction

```{r regression-credit}
#| label: tbl-regression-credit
#| tbl-cap: "Credit Interaction Comparison"

if (has_tz_targets && has_eth_targets) {
  tz_credit <- run_credit_interaction_regression(tz_targets, return_results = TRUE)
  eth_credit <- run_credit_interaction_regression(eth_targets, return_results = TRUE)

  credit_df <- data.frame(
    Country = c("Tanzania", "Ethiopia"),
    `Interaction Coefficient` = c(tz_credit$coefficient, eth_credit$coefficient),
    `Std. Error` = c(tz_credit$std_error, eth_credit$std_error),
    `P-value` = c(tz_credit$p_value, eth_credit$p_value),
    `Sign Correct` = c(tz_credit$sign_match, eth_credit$sign_match),
    check.names = FALSE
  )

  credit_df |>
    gt::gt() |>
    gt::fmt_number(columns = c(`Interaction Coefficient`, `Std. Error`), decimals = 4) |>
    gt::fmt_scientific(columns = `P-value`, decimals = 2) |>
    gt::tab_header(
      title = "Credit Interaction Effect",
      subtitle = "Target: beta_2 < 0 (credit-constrained households more responsive)"
    )
} else {
  tz_credit <- eth_credit <- list(coefficient = NA, std_error = NA, sign_match = NA)
}
```

## 3.4 Coefficient Comparison Plot

```{r coefficient-plot}
#| label: fig-coefficient-comparison
#| fig-cap: "Coefficient Comparison Across Countries"

if (has_tz_targets && has_eth_targets) {
  coef_data <- data.frame(
    coefficient = c("Primary (price_exposure)",
                   "Asset Interaction",
                   "Credit Interaction"),
    Tanzania = c(tz_primary$coefficient, tz_assets$coefficient, tz_credit$coefficient),
    Ethiopia = c(eth_primary$coefficient, eth_assets$coefficient, eth_credit$coefficient),
    Tanzania_SE = c(tz_primary$std_error, tz_assets$std_error, tz_credit$std_error),
    Ethiopia_SE = c(eth_primary$std_error, eth_assets$std_error, eth_credit$std_error)
  )

  coef_long <- coef_data |>
    pivot_longer(
      cols = c(Tanzania, Ethiopia),
      names_to = "country",
      values_to = "estimate"
    ) |>
    left_join(
      coef_data |>
        pivot_longer(
          cols = c(Tanzania_SE, Ethiopia_SE),
          names_to = "country_se",
          values_to = "se"
        ) |>
        mutate(country = gsub("_SE", "", country_se)) |>
        select(coefficient, country, se),
      by = c("coefficient", "country")
    )

  ggplot(coef_long, aes(x = coefficient, y = estimate, color = country)) +
    geom_point(position = position_dodge(width = 0.5), size = 3) +
    geom_errorbar(aes(ymin = estimate - 1.96 * se, ymax = estimate + 1.96 * se),
                  position = position_dodge(width = 0.5), width = 0.2) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
    scale_color_manual(values = c("Tanzania" = "steelblue", "Ethiopia" = "darkgreen")) +
    labs(
      title = "Coefficient Estimates with 95% Confidence Intervals",
      subtitle = "All coefficients expected to be negative",
      x = "",
      y = "Coefficient Estimate",
      color = "Country"
    ) +
    theme(legend.position = "bottom") +
    coord_flip()
}
```

# Part 4: Summary {.tabset}

## 4.1 Combined Portability Summary

```{r portability-summary}
#| label: tbl-portability-summary
#| tbl-cap: "Combined Portability Validation Summary"

summary_rows <- list()

# LLM Generalization (if available)
if (has_cross_country_eval && has_tz_eval) {
  llm_gap <- llm_tz$macro_f1 - llm_cross$macro_f1
  ml_gap <- best_ml_tz$macro_f1 - best_ml_cross$macro_f1

  summary_rows[[length(summary_rows) + 1]] <- data.frame(
    Test = "LLM Generalization Gap",
    Value = sprintf("%.3f (same: %.3f, cross: %.3f)", llm_gap, llm_tz$macro_f1, llm_cross$macro_f1),
    Criterion = "< 0.10",
    Status = format_status(llm_gap < 0.10)
  )

  summary_rows[[length(summary_rows) + 1]] <- data.frame(
    Test = "LLM vs ML Generalization",
    Value = sprintf("LLM gap: %.3f, ML gap: %.3f", llm_gap, ml_gap),
    Criterion = "LLM gap <= ML gap",
    Status = format_status(llm_gap <= ml_gap)
  )

  summary_rows[[length(summary_rows) + 1]] <- data.frame(
    Test = "LLM Cross-Country F1",
    Value = sprintf("%.3f", llm_cross$macro_f1),
    Criterion = "> 0.30",
    Status = format_status(llm_cross$macro_f1 > 0.30)
  )
}

# Regression-based portability (if available)
if (has_tz_targets && has_eth_targets) {
  sign_preserved_primary <- (tz_primary$coefficient < 0) == (eth_primary$coefficient < 0)
  sign_preserved_assets <- (tz_assets$coefficient < 0) == (eth_assets$coefficient < 0)
  sign_preserved_credit <- (tz_credit$coefficient < 0) == (eth_credit$coefficient < 0)

  summary_rows[[length(summary_rows) + 1]] <- data.frame(
    Test = "Primary Effect Sign Preservation",
    Value = sprintf("TZ: %s, ETH: %s",
                    if (tz_primary$coefficient < 0) "-" else "+",
                    if (eth_primary$coefficient < 0) "-" else "+"),
    Criterion = "Same sign",
    Status = format_status(sign_preserved_primary)
  )

  summary_rows[[length(summary_rows) + 1]] <- data.frame(
    Test = "Asset Interaction Sign Preservation",
    Value = sprintf("TZ: %s, ETH: %s",
                    if (tz_assets$coefficient < 0) "-" else "+",
                    if (eth_assets$coefficient < 0) "-" else "+"),
    Criterion = "Same sign",
    Status = format_status(sign_preserved_assets)
  )

  summary_rows[[length(summary_rows) + 1]] <- data.frame(
    Test = "Credit Interaction Sign Preservation",
    Value = sprintf("TZ: %s, ETH: %s",
                    if (tz_credit$coefficient < 0) "-" else "+",
                    if (eth_credit$coefficient < 0) "-" else "+"),
    Criterion = "Same sign",
    Status = format_status(sign_preserved_credit)
  )
}

if (length(summary_rows) > 0) {
  summary_df <- do.call(rbind, summary_rows)

  summary_df |>
    gt::gt() |>
    gt::tab_header(
      title = "Portability Validation Summary",
      subtitle = "Cross-Country Generalization Assessment"
    ) |>
    gt::tab_style(
      style = list(gt::cell_fill(color = "#d4edda")),
      locations = gt::cells_body(columns = Status, rows = Status == "PASS")
    ) |>
    gt::tab_style(
      style = list(gt::cell_fill(color = "#f8d7da")),
      locations = gt::cells_body(columns = Status, rows = Status == "FAIL")
    ) |>
    gt::tab_style(
      style = list(gt::cell_fill(color = "#e2e3e5")),
      locations = gt::cells_body(columns = Status, rows = Status == "N/A")
    )
} else {
  cat("No portability validation results available.\n")
}
```

## 4.2 Conclusions

```{r conclusions}
#| results: hold

cat("=== PORTABILITY VALIDATION SUMMARY ===\n\n")

# LLM generalization summary
if (has_cross_country_eval && has_tz_eval) {
  llm_gap <- llm_tz$macro_f1 - llm_cross$macro_f1
  ml_gap <- best_ml_tz$macro_f1 - best_ml_cross$macro_f1

  cat("LLM GENERALIZATION:\n")
  cat(sprintf("  - Same-Country F1: %.3f\n", llm_tz$macro_f1))
  cat(sprintf("  - Cross-Country F1: %.3f\n", llm_cross$macro_f1))
  cat(sprintf("  - Generalization Gap: %.3f\n", llm_gap))
  cat(sprintf("  - Best ML Gap: %.3f\n", ml_gap))
  cat(sprintf("  - LLM Generalizes Better: %s\n\n",
              if (llm_gap <= ml_gap) "YES" else "NO"))
}

# Regression-based summary
if (has_tz_targets && has_eth_targets) {
  sign_preserved_primary <- (tz_primary$coefficient < 0) == (eth_primary$coefficient < 0)
  sign_preserved_assets <- (tz_assets$coefficient < 0) == (eth_assets$coefficient < 0)
  sign_preserved_credit <- (tz_credit$coefficient < 0) == (eth_credit$coefficient < 0)
  all_signs_preserved <- sign_preserved_primary && sign_preserved_assets && sign_preserved_credit

  cat("REGRESSION-BASED PORTABILITY:\n")
  cat(sprintf("  - Primary Effect Sign: %s\n", format_status(sign_preserved_primary)))
  cat(sprintf("  - Asset Interaction Sign: %s\n", format_status(sign_preserved_assets)))
  cat(sprintf("  - Credit Interaction Sign: %s\n", format_status(sign_preserved_credit)))
  cat(sprintf("  - All Signs Preserved: %s\n\n", format_status(all_signs_preserved)))
}

# Overall assessment
llm_portable <- if (has_cross_country_eval && has_tz_eval) {
  llm_gap < 0.10 && llm_cross$macro_f1 > 0.30
} else {
  NA
}

regression_portable <- if (has_tz_targets && has_eth_targets) {
  all_signs_preserved
} else {
  NA
}

if (!is.na(llm_portable) && !is.na(regression_portable)) {
  overall <- llm_portable && regression_portable
  cat(sprintf("=== OVERALL PORTABILITY STATUS: %s ===\n", if (overall) "PASS" else "NEEDS REVIEW"))
} else if (!is.na(llm_portable)) {
  cat(sprintf("=== LLM GENERALIZATION: %s ===\n", if (llm_portable) "PASS" else "FAIL"))
} else if (!is.na(regression_portable)) {
  cat(sprintf("=== REGRESSION PORTABILITY: %s ===\n", if (regression_portable) "PASS" else "FAIL"))
}

cat("\n")
if (has_cross_country_eval && has_tz_eval) {
  if (llm_gap <= ml_gap) {
    cat("KEY FINDING: LLM shows equal or better generalization than ML baselines.\n")
    cat("This suggests LLM decisions may capture more fundamental patterns\n")
    cat("that transfer across contexts without overfitting to country-specific data.\n")
  } else {
    cat("NOTE: ML baselines show better generalization than LLM.\n")
    cat("Consider investigating LLM prompt design or decision patterns.\n")
  }
}
```

---

*Report generated on `r Sys.time()`*
